apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: expense-tracker-rules
  namespace: monitoring
  labels:
    release: prometheus-stack
spec:
  groups:
    - name: expense-tracker
      rules:
        - record: job:http_requests_total:rate5m
          expr: sum(rate(http_requests_total[5m])) by (job)
        
        - alert: HighResponseTime
          expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: High response time
            description: P95 response time is above 200ms for 5 minutes
        
        - alert: LowCacheHitRatio
          expr: sum(rate(cache_hits_total[5m])) / (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m]))) < 0.5
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Low cache hit ratio
            description: Cache hit ratio is below 50% for 10 minutes
        
        - alert: HighErrorRate
          expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.05
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: High error rate
            description: Error rate is above 5% for 5 minutes
